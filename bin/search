#!/bin/bash

usage() {
    echo "Usage: ${0##*/} regexp [path]"
    exit 0
}

_find() {
    find "${1:-$PWD}" \
        -path '*/.git/*' -prune -o \
        -path '*/.svn/*' -prune -o \
        -path '*/.cache/*' -prune -o \
        -type l -print -o \
        -type f -print
}


if [[ $1 == "--help" ]] || [[ $1 == "-h" ]]; then usage; fi

if [[ $# == 1 ]]; then
    if [[ -d "$1" ]]; then
        _find
    else
        _find | xargs -P $(nproc) grep -nHE "$1" 2>/dev/null
    fi
elif [[ $# == 2 ]]; then
    _find "$2" | xargs -P $(nproc) grep -nHE "$1" 2>/dev/null
else
    _find
fi
